# Wallet Service

Простой RESTful сервис для управления балансом цифровых кошельков, реализованный на Spring Boot и PostgreSQL. Сервис позволяет пополнять счет, списывать средства и проверять текущий баланс кошелька. Особое внимание уделено обработке конкурентных запросов на один и тот же кошелек.

## Функционал

*   **Пополнение (DEPOSIT):** Увеличение баланса кошелька на указанную сумму.
*   **Снятие (WITHDRAW):** Уменьшение баланса кошелька на указанную сумму с проверкой достаточности средств.
*   **Получение баланса:** Запрос текущего баланса для указанного кошелька (с использованием кэширования).
*   **Получение id всех кошельков:** Запрос на получение списка id всех существующих кошельков.
*   **Высокая конкурентность:** Сервис спроектирован для обработки высокой нагрузки (целевая ~1000 RPS) на один кошелек с использованием атомарных операций БД и механизма повторных попыток (retry).
*   **Управление миграциями БД:** Структура базы данных управляется с помощью Liquibase.
*   **Контейнеризация:** Приложение и база данных запускаются в Docker-контейнерах с помощью Docker Compose.

## Технологический стек

*   **Java:** 17
*   **Spring Boot:** 3.3.1
    *   Spring Web
    *   Spring Data JPA
    *   Spring Cache (Caffeine)
    *   Spring Retry
    *   Spring AOP
    *   Spring Validation
*   **База данных:** PostgreSQL 16 (Alpine)
*   **Управление миграциями:** Liquibase
*   **Кэш:** Caffeine
*   **Сборка:** Maven
*   **Контейнеризация:** Docker, Docker Compose

## Конфигурация

Основные параметры конфигурации задаются через переменные окружения в файле `docker-compose.yml` или через переменные окружения системы/файлы `.env`.

**Сервис приложения (`app`):**

*   `DB_URL`: JDBC URL для подключения к базе данных (по умолчанию `jdbc:postgresql://db:5432/walletdb`, указывает на контейнер `db`).
*   `DB_USER`: Имя пользователя базы данных.
*   `DB_PASSWORD`: Пароль пользователя базы данных.
*   `SPRING_PROFILES_ACTIVE`: Активный профиль Spring Boot (по умолчанию `docker`).

**База данных (`db`):**

*   `POSTGRES_DB`: Имя базы данных для создания.
*   `POSTGRES_USER`: Имя суперпользователя PostgreSQL.
*   `POSTGRES_PASSWORD`: Пароль суперпользователя PostgreSQL.

Настройки пула соединений HikariCP, кеша Caffeine и другие параметры Spring Boot настраиваются в `src/main/resources/application.yml`

## Запуск приложения

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <git@github.com:Lminexx/WalletService.git>
    cd walletService
    ```

2.  **Соберите JAR-файл приложения с помощью Maven:**
    ```bash
    mvn clean package -DskipTests
    ```

3.  **Запустите сервисы с помощью Docker Compose:**
    ```bash
    docker-compose up -d
    ```

4.  **Проверка логов (при необходимости):**
    *   Логи приложения: `docker-compose logs -f app`
    *   Логи базы данных: `docker-compose logs -f db`

5.  **Приложение будет доступно по адресу:** `http://localhost:8080`

## API Endpoints

Базовый URL: `/api/v1`

---

### 1. Выполнить операцию (Пополнение/Снятие)

*   **URL:** `/wallet`
*   **Метод:** `POST`
*   **Content-Type:** `application/json`
*   **Тело запроса:**
    ```json
    {
      "walletId": "UUID",        // UUID кошелька (например, "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11")
      "operationType": "DEPOSIT", // или "WITHDRAW"
      "amount": 100.50           // Сумма операции (BigDecimal)
    }
    ```
*   **Успешный ответ:**
    *   Код: `200 OK`
    *   Тело: (пустое)
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат запроса, невалидные данные (например, отрицательная сумма), недостаточно средств (`InsufficientFundsException`).
    *   `404 Not Found`: Кошелек с указанным `walletId` не найден (`WalletNotFoundException`).
    *   `500 Internal Server Error`: Непредвиденные ошибки сервера (например, проблемы с БД).

---

### 2. Получить баланс кошелька

*   **URL:** `/wallets/{walletId}`
*   **Метод:** `GET`
*   **Параметр пути:**
    *   `{walletId}`: UUID кошелька.
*   **Успешный ответ:**
    *   Код: `200 OK`
    *   **Content-Type:** `application/json`
    *   Тело:
        ```json
        {
          "walletId": "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
          "balance": 1250.75
        }
        ```
*   **Ошибки:**
    *   `404 Not Found`: Кошелек с указанным `walletId` не найден (`WalletNotFoundException`).

---

### 3. Создать новый кошелек

*   **URL:** `/wallets`
*   **Метод:** `POST`
*   **Тело запроса:** (пустое)
*   **Успешный ответ:**
    *   Код: `201 Created`
    *   **Content-Type:** `application/json`
    *   Тело: (информация о созданном кошельке, например, как в GET /wallets/{walletId})
        ```json
        {
          "walletId": "НОВЫЙ_UUID",
          "balance": 0.00
        }
        ```
---

### 4. Получить все ID кошельков

*   **URL:** `/wallets`
*   **Метод:** `GET`
*   **Успешный ответ:**
    *   Код: `200 OK`
    *   **Content-Type:** `application/json`
    *   Тело: (Список UUID всех существующих кошельков)
        ```json
        [
          "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
          "f47ac10b-58cc-4372-a567-0e02b2c3d479",
          "..."
        ]
        ```
*   **Ошибки:**
    *   `500 Internal Server Error`: Непредвиденные ошибки сервера (например, проблемы с БД).

## Тестирование производительности

Сервис успешно прошел нагрузочное тестирование с помощью JMeter, показав способность обрабатывать около **1000 запросов в секунду** (пополнение и снятие) на один идентификатор кошелька с **0% ошибок** и медианным временем отклика **~1 мс**. Это достигается за счет использования атомарных операций обновления в PostgreSQL и механизма повторных попыток Spring Retry для обработки конфликтов конкурентного доступа.

